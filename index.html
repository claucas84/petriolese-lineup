<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Petriolese — Matchday (3-4-1-2)</title>
  <meta name="theme-color" content="#0b0f0c">
  <link rel="preconnect" href="https://docs.google.com">
  <link rel="dns-prefetch" href="https://docs.google.com">
  <style>
    :root{
      --club-red:#e11d48;     /* rosso sociale */
      --club-blue:#1d4ed8;    /* blu sociale */
      --bench:var(--club-blue);
      --bg:#0b0f0c; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}

    /* Topbar */
    .topbar{width:100%;display:grid;grid-template-columns:auto 1fr;gap:12px;align-items:center;padding:12px 16px;border-bottom:2px solid rgba(29,78,216,.35)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{width:42px;height:42px;object-fit:contain}
    .brand .club{font-weight:900;letter-spacing:.3px}
    .matchline{font-weight:800;text-transform:uppercase;text-align:right}
    .subline{font-size:12px;color:var(--muted)}
    @media (max-width:520px){.matchline{font-size:14px}}

    .wrap{min-height:100svh;display:grid;place-items:start center;padding:8px 16px calc(16px + env(safe-area-inset-bottom))}
    .board{display:grid;gap:16px;grid-template-columns:1fr;width:100%;max-width:960px}
    @media (min-width:860px){.board{grid-template-columns:minmax(300px,520px) 1fr;align-items:start;gap:20px}}

    /* Campo */
    .pitch{position:relative;width:100%;max-width:520px;aspect-ratio:2/3;margin:0 auto;border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.30);overflow:hidden;border:2px solid rgba(29,78,216,.25)}
    .pitch>img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}

    /* Titolari: pallino bicolore, numero sopra, cognome al centro (7px) */
    .player{
      position:absolute;transform:translate(-50%,-50%);
      width:clamp(60px,11vw,88px);height:clamp(60px,11vw,88px);
      border-radius:999px;overflow:hidden;box-shadow:0 6px 16px rgba(0,0,0,.35);border:2px solid rgba(255,255,255,.7);
      background:linear-gradient(90deg,var(--club-red) 0 50%,var(--club-blue) 50% 100%);
      display:grid;place-items:center;padding:6px; /* un filo di respiro per il testo */
    }
    .num-badge{
      position:absolute;left:50%;transform:translate(-50%,-100%);top:-8px;
      background:var(--club-blue);color:#fff;border:2px solid rgba(255,255,255,.7);
      border-radius:999px;padding:2px 8px;font-weight:900;font-size:12px;line-height:1
    }
    .surname-center{
      color:#fff;font-weight:900;text-transform:uppercase;text-align:center;
      font-size:7px; line-height:1.05;
      white-space:normal;word-break:break-word; /* mai ellissi */
      text-shadow:0 1px 1px rgba(0,0,0,.35)
    }

    /* Colonna laterale */
    .side{display:grid;gap:16px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
    .title{font-weight:800;letter-spacing:.2px;font-size:14px;color:#fff}

    /* Panchina grande */
    .bench{display:grid;grid-template-columns:repeat(auto-fit,minmax(clamp(84px,22vw,140px),1fr));gap:14px;justify-content:center;max-width:min(100%,520px);margin:8px auto 0}
    .bench .item{display:grid;grid-template-rows:auto auto auto;justify-items:center;gap:6px;position:relative}
    .bench .num-badge{position:relative;top:0;transform:none;background:var(--club-blue);color:#fff;border:2px solid rgba(255,255,255,.7);border-radius:999px;padding:3px 10px;font-weight:900;font-size:12px;line-height:1}
    .bench .avatar{width:clamp(64px,18vw,110px);height:clamp(64px,18vw,110px);border-radius:999px;overflow:hidden;background:var(--bench);border:2px solid rgba(255,255,255,.55);box-shadow:0 4px 12px rgba(0,0,0,.25);display:grid;place-items:center}
    .bench .avatar img{width:100%;height:100%;object-fit:cover}
    .bench .name{font-size:12px;text-align:center;color:#e5e7eb;white-space:normal;word-break:break-word;line-height:1.05}

    .notice{font-size:12px;color:var(--muted);text-align:center;margin-top:2px}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <img id="clubLogo" src="CLAUDIO LOGO.jpg" alt="Logo Petriolese" onerror="this.style.display='none'"/>
      <div class="club">Petriolese Calcio</div>
    </div>
    <div>
      <div class="matchline" id="matchLine">PETRIOLESE vs AVVERSARIO</div>
      <div class="subline" id="matchWhen"></div>
    </div>
  </header>

  <main class="wrap">
    <section class="board">
      <!-- CAMPO -->
      <div class="pitch" id="pitch">
        <img id="pitchImg"
          src="https://tse3.mm.bing.net/th/id/OIP.xR8peX5FCoXBMSXQkppsfwAAAA?pid=Api"
          alt="Mezzo campo da calcio, vista dall'alto"
          loading="lazy" decoding="async"/>
      </div>

      <!-- SOLO PANCHINA -->
      <aside class="side">
        <div class="card">
          <div class="title">Panchina (12–20 + ALL)</div>
          <div class="bench" id="bench"></div>
          <div class="notice" id="notice">Carico i dati…</div>
        </div>
      </aside>
    </section>
  </main>

  <script>
    /* Link "pubhtml" */
    const PUBLISHED_META_URL =
      'https://docs.google.com/spreadsheets/u/2/d/e/2PACX-1vSpJqXmoJaIznEo_EGHCfUxyYVWWKJCGULM9FbnI14hLhGpsjt3oMHT5ahJwEmJ4w/pubhtml?gid=254048258&single=true';
    const PUBLISHED_DIST_URL =
      'https://docs.google.com/spreadsheets/u/2/d/e/2PACX-1vSpJqXmoJaIznEo_EGHCfUxyYVWWKJCGULM9FbnI14hLhGpsjt3oMHT5ahJwEmJ4w/pubhtml?gid=116187224&single=true';

    /* Numeri fissi per 3-4-1-2 (ordine posizionale):
       GK, RCB,  CB,  LCB, RWB, CM-R, CM-L, LWB,  AM,  ST1, ST2
        1,   2,   5,   3,   7,   6,    4,   11,  10,   9,   8 */
    const XI_NUMBERS = [1,2,5,3,7,6,4,11,10,9,8];
    const BENCH_NUMBERS = [12,13,14,15,16,17,18,19,20];

    /* Coordinate aggiornate:
       - 7 & 11 allineati a 4 e 6 (y=56)
       - 2,3,5 e 1 più avanti; 5 (y=84) non si sovrappone con 1 (y=92) */
    const coords3412 = [
      [50,92], // 1 GK (avanzato, ma dietro al 5)
      [72,76], // 2 RCB più avanti
      [50,84], // 5 CB più avanti ma separato dal GK
      [28,76], // 3 LCB più avanti
      [88,56], // 7 RWB allineato al CM-R
      [60,56], // 6 CM-R
      [40,56], // 4 CM-L
      [12,56], // 11 LWB allineato al CM-L
      [50,38], // 10 AM
      [62,18], // 9 ST-R
      [38,18]  // 8 ST-L
    ];

    const el = s => document.querySelector(s);

    function pubToCsv(u){
      try{
        const url = new URL(u);
        url.pathname = url.pathname.replace(/\/u\/\d+\//,'/').replace(/\/pubhtml(?:\/)?$/,'/pub');
        url.searchParams.set('output','csv');
        return url.toString();
      }catch(e){ return u; }
    }

    function parseCSV(text){
      const rows=[];let cur='',row=[],inQuotes=false;
      for(let i=0;i<text.length;i++){
        const c=text[i],n=text[i+1];
        if(inQuotes){ if(c==='"'&&n==='"'){cur+='"';i++;} else if(c==='"'){inQuotes=false;} else{cur+=c;} }
        else{ if(c==='"'){inQuotes=true;} else if(c===','){row.push(cur);cur='';}
          else if(c=='\n'){row.push(cur);rows.push(row);row=[];cur='';} else{cur+=c;} }
      }
      if(cur!==''||row.length){row.push(cur);rows.push(row);}
      const header=rows.shift().map(h=>h.trim());
      return rows.filter(r=>r.length).map(r=>Object.fromEntries(header.map((h,i)=>[h,r[i]!==undefined?r[i]:'' ])));
    }

    async function fetchPublishedCSV(u){
      const url=pubToCsv(u);
      const res=await fetch(url,{cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status+' per '+url);
      let txt=await res.text();
      txt=txt.replace(/\r\n?/g,'\n');
      return parseCSV(txt);
    }

    function normalizeMeta(rows){
      const out={}; rows.forEach(r=>{ const k=String(r.Key||r.Chiave||'').trim(); const v=String(r.Value||r.Valore||'').trim(); if(k) out[k]=v; });
      return out;
    }
    function normalizeDistinta(rows){
      const mapped=rows.map(r=>{
        const keys=Object.fromEntries(Object.entries(r).map(([k,v])=>[k.toLowerCase().replace(/\s+/g,'').replace(/é/g,'e'),v]));
        const num=Number(keys.num||keys.numero||0)||0;
        const name=(keys.nome||keys.giocatore||'').toString();
        const photo=(keys.foto||keys.photo||'').toString();
        return {num,name,photo};
      }).filter(x=>x.num>0);
      const byNum=new Map(); mapped.forEach(x=>byNum.set(x.num,x)); return byNum;
    }
    const surname = full => {
      const t=String(full||'').trim(); if(!t) return '';
      const p=t.split(/\s+/); return p[p.length-1];
    };

    function renderAll(meta, byNum){
      // Header
      const match={home:'PETRIOLESE', away:meta.Avversario||'AVVERSARIO', when:meta.When||''};
      const logoURL=meta.LogoURL||'';
      el('#clubLogo').src=logoURL||'CLAUDIO LOGO.jpg';
      el('#matchLine').textContent=`${match.home} vs ${match.away}`;
      el('#matchWhen').textContent=match.when;
      if(meta.PitchURL) el('#pitchImg').src=meta.PitchURL;

      // Campo: XI (bicolore, cognome al centro, numero sopra)
      const pitch=el('#pitch'); pitch.querySelectorAll('.player').forEach(n=>n.remove());
      XI_NUMBERS.forEach((num,i)=>{
        const p=byNum.get(num)||{num,name:'',photo:''};
        const [x,y]=coords3412[i]||[50,50];
        const node=document.createElement('div'); node.className='player'; node.style.left=x+'%'; node.style.top=y+'%';

        const nb=document.createElement('div'); nb.className='num-badge'; nb.textContent=num; node.appendChild(nb);
        const sur=document.createElement('div'); sur.className='surname-center'; sur.textContent=(surname(p.name)||''); node.appendChild(sur);

        pitch.appendChild(node);
      });

      // Panchina (con extra "ALL" Castellani)
      const benchEl=el('#bench'); benchEl.innerHTML='';
      const benchItems = [
        ...BENCH_NUMBERS.map(n=>{
          const bp = byNum.get(n)||{num:n,name:'',photo:''};
          return {code:String(n), name:bp.name, photo:bp.photo};
        }),
        {code:'ALL', name:'Castellani', photo:''}
      ];
      benchItems.forEach(item=>{
        const card=document.createElement('div'); card.className='item';
        const nb=document.createElement('div'); nb.className='num-badge'; nb.textContent=item.code; card.appendChild(nb);
        const av=document.createElement('div'); av.className='avatar';
        if(item.photo){ const img=document.createElement('img'); img.src=item.photo; img.alt=item.name; img.onerror=()=>img.remove(); av.appendChild(img); }
        card.appendChild(av);
        const nm=document.createElement('div'); nm.className='name'; nm.textContent=item.name||''; card.appendChild(nm);
        benchEl.appendChild(card);
      });

      el('#notice').textContent='Dati caricati dai link pubblicati (CSV)';
    }

    (async function init(){
      try{
        const [metaRows,distRows]=await Promise.all([
          fetchPublishedCSV(PUBLISHED_META_URL),
          fetchPublishedCSV(PUBLISHED_DIST_URL)
        ]);
        const meta=normalizeMeta(metaRows);
        const byNum=normalizeDistinta(distRows);
        renderAll(meta,byNum);
      }catch(e){
        console.error(e);
        el('#notice').textContent='Errore nel leggere i CSV pubblicati: '+e.message;
        renderAll({}, new Map());
      }
    })();
  </script>
</body>
</html>
